# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

platform :ios do
  desc "æ³¨å†Œæ‰‹æœºudidåˆ°æŒ‡å®šAppIdè´¦å·"
  lane :addUdids do |option|
      #æ¥æ”¶åˆ°çš„æ‰€æœ‰å‚æ•°
      puts "æ¥æ”¶åˆ°çš„æ‰€æœ‰å‚æ•° #{option}"
      udidsStr = option[:udids]
      username = option[:appleid]
      if option.keys.size>0
         #å­—ç¬¦ä¸² -> æ•°ç»„
         udidsArray = udidsStr.split(",")
         puts "éœ€è¦æ·»åŠ çš„udidé›†åˆ #{udidsArray}"
         #æ•°ç»„ -> å­—å…¸ï¼ˆhashï¼‰
         udidsDic = {}
         for tmpUdid in udidsArray do
            tmpDic = {tmpUdid => tmpUdid}
            udidsDic = udidsDic.merge tmpDic
         end
         puts udidsDic
         #æ·»åŠ udid
         register_devices(
           devices:udidsDic,
           username: username,
         )
      elsif
         puts "âš ï¸ âš ï¸ âš ï¸  udidsé›†åˆä¸ºç©º  âš ï¸ âš ï¸ âš ï¸"
      end
  end


  #signä½¿ç”¨å‚è€ƒhttps://docs.fastlane.tools/actions/sigh/
  desc "ä¸‹è½½provisioning_profileï¼Œä¸å­˜åœ¨çš„bundleidå’Œcertificatesè‡ªåŠ¨æ–°å»ºå¹¶ä¸‹è½½"
  lane :downloadsProfile do |option|
      #æ¥æ”¶åˆ°çš„æ‰€æœ‰å‚æ•°
      puts "æ¥æ”¶åˆ°çš„æ‰€æœ‰å‚æ•° #{option}"
      bundleid = option[:bundleid] #bundleid
      username = option[:appleid] #Apple IDç”¨æˆ·å
      name = option[:name] #Apple Developer Portalä¸Šä½¿ç”¨çš„é…ç½®æ–‡ä»¶çš„åç§°
      cer = option[:cer] #0è¯ä¹¦å·²ç»è¡¨ç¤ºå­˜åœ¨ 1è¡¨ç¤ºä¸å­˜åœ¨
      mobileprovision = option[:mobileprovision] #0æè¿°æ–‡ä»¶å·²ç»è¡¨ç¤ºå­˜åœ¨ 1è¡¨ç¤ºä¸å­˜åœ¨
      #å¦‚æœæ²¡æœ‰åœ¨Apple Developeråˆ›å»ºè¯ä¹¦çš„è¯ï¼Œget_certificatesä¼šå¸®ä½ è‡ªåŠ¨åˆ›å»ºè¯ä¹¦
      puts "cer=#{cer}"
      puts "mobileprovision=#{mobileprovision}"
      if cer.to_i == 1
      	 get_certificates(
           username: username,
           #keychain_password: "123",
         )
      else
         puts "certificateså·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»ºæ­¥éª¤"
      end
         
      #åœ¨å¼€å‘è€…è´¦å·åˆ›å»ºappidï¼ˆæ­¤æ–¹æ³•å¾…ä¼˜åŒ–ï¼Œæ¯”è¾ƒè€—æ—¶ï¼‰
      if mobileprovision.to_i == 1
	    produce(
               username:username,
	       app_identifier: bundleid,
               app_name: bundleid,
            )
      else
	 puts "mobileprovisionå·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»ºæ­¥éª¤"
      end
      initError = ""
      if bundleid==nil
         initError = "âš ï¸ âš ï¸ âš ï¸  bundleid(bundleid)ä¸ºç©ºï¼Œè¯·è¡¥å……  âš ï¸ âš ï¸ âš ï¸"
      elsif username==nil
         initError = "âš ï¸ âš ï¸ âš ï¸  appleid(Apple IDç”¨æˆ·å)ä¸ºç©ºï¼Œè¯·è¡¥å……  âš ï¸ âš ï¸ âš ï¸"
      elsif name==nil
         initError = "âš ï¸ âš ï¸ âš ï¸  name(é…ç½®æ–‡ä»¶åç§°)ä¸ºç©ºï¼Œè¯·è¡¥å……  âš ï¸ âš ï¸ âš ï¸"
      else
         puts "å‚æ•°è·å–æ­£å¸¸"
      end
      if initError.length==0
         sigh(
              username:username,
              app_identifier: bundleid,
              force: true,
              provisioning_name: name,
              ignore_profiles_with_different_name: true,
              adhoc: true,
         )
      else
         puts initError
      end
  end

  desc "å•çº¯ä¸‹è½½provisioning_profileï¼Œä¸å­˜åœ¨çš„bundleidè‡ªåŠ¨æ–°å»ºå¹¶ä¸‹è½½ï¼ˆå·²åºŸå¼ƒï¼‰"
  lane :adhoc_profile do |option|
      #æ¥æ”¶åˆ°çš„æ‰€æœ‰å‚æ•°
      puts "æ¥æ”¶åˆ°çš„æ‰€æœ‰å‚æ•° #{option}"
      bundleid = option[:bundleid] #bundleid
      username = option[:appleid] #Apple IDç”¨æˆ·å
      name = option[:name] #Apple Developer Portalä¸Šä½¿ç”¨çš„é…ç½®æ–‡ä»¶çš„åç§°
      get_provisioning_profile(
         username:username,
      	 adhoc: true,
      	 force: true,
      	 filename: "name.mobileprovision",
         app_identifier: bundleid,
      )
  end

    lane :test do |option|
      #æ¥æ”¶åˆ°çš„æ‰€æœ‰å‚æ•°
      puts "æ¥æ”¶åˆ°çš„æ‰€æœ‰å‚æ•° #{option}"
      bundleid = option[:bundleid] #bundleid
      username = option[:appleid] #Apple IDç”¨æˆ·å
      name = option[:name] #Apple Developer Portalä¸Šä½¿ç”¨çš„é…ç½®æ–‡ä»¶çš„åç§°
      puts "è¯·è¾“å…¥ç‰ˆæœ¬æè¿°ï¼š"
      desc = STDIN.gets
      puts "å¼€å§‹æ‰“åŒ… #{desc}"
  end


 
  before_all  do |options|
     puts "ğŸš€ğŸš€ğŸš€ fastlane åˆå§‹åŒ–å‡†å¤‡æ‰§è¡Œ ğŸš€ğŸš€ğŸš€"
  end
  
  before_each  do |options|
     puts "ğŸš€ğŸš€ğŸš€ lane #{options}åˆå§‹åŒ–å‡†å¤‡æ‰§è¡Œ ğŸš€ğŸš€ğŸš€"
  end
  
  after_each  do |options|
     puts "ğŸš€ğŸš€ğŸš€ lane #{options}æ‰§è¡Œå®Œæˆ ğŸš€ğŸš€ğŸš€"
  end
  
  after_each  do |options|
     puts "ğŸš€ğŸš€ğŸš€ fastlane å®Œæˆæ‰§è¡Œ ğŸš€ğŸš€ğŸš€"
  end
  
  error  do |options|
     puts "âš ï¸ âš ï¸ âš ï¸  lane #{options}å‡ºç°é”™è¯¯  âš ï¸ âš ï¸ âš ï¸"
  end

end
